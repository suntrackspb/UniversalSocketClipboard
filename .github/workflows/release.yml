name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build:
    name: Build binaries
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev xorg-dev libxtst-dev libpng++-dev xcb libxcb-xkb-dev x11-xkb-utils libx11-xcb-dev libxkbcommon-x11-dev libxkbcommon-dev

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Get dependencies
        run: |
          rm -f go.sum
          go mod download
          go mod tidy

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Server (OpenWRT ARM64)
        run: |
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -trimpath \
            -o bin/clipboard-server-openwrt \
            ./cmd/server
          
      - name: Build Client (Windows x64)
        run: |
          GOOS=windows GOARCH=amd64 go build \
            -ldflags="-s -w -H=windowsgui -X main.version=${{ steps.version.outputs.VERSION }}" \
            -trimpath \
            -o bin/clipboard-client-windows.exe \
            ./cmd/client

      - name: Build Client (Linux x64)
        run: |
          GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -trimpath \
            -o bin/clipboard-client-linux \
            ./cmd/client

      # macOS ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ ÑÐ¾Ð±Ð¸Ñ€Ð°ÑŽÑ‚ÑÑ Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¼ job Ð½Ð° macOS runner

      - name: Create macOS Universal Binary
        run: |
          # Ð”Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¸ÐºÐ° Ð½ÑƒÐ¶ÐµÐ½ lipo, Ð½Ð¾ Ð¼Ñ‹ Ð½Ð° Linux
          # ÐŸÐ¾ÑÑ‚Ð¾Ð¼Ñƒ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð¸Ð¼ Ð¾Ð±Ð° Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð° Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾
          echo "macOS binaries built separately for ARM64 and AMD64"

      - name: Display binary sizes
        run: |
          echo "ðŸ“¦ Binary sizes:"
          ls -lh bin/
          echo ""
          echo "Total size: $(du -sh bin/ | cut -f1)"

      - name: Create checksums
        run: |
          cd bin
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create release archive
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²Ñ‹ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹
          cd bin
          
          # Server
          tar -czf clipboard-server-openwrt-${{ steps.version.outputs.VERSION }}.tar.gz clipboard-server-openwrt
          
          # Windows
          zip clipboard-client-windows-${{ steps.version.outputs.VERSION }}.zip clipboard-client-windows.exe
          
          # Linux
          tar -czf clipboard-client-linux-${{ steps.version.outputs.VERSION }}.tar.gz clipboard-client-linux
          
          ls -lh *.tar.gz *.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux
          path: |
            bin/clipboard-server-openwrt
            bin/clipboard-client-windows.exe
            bin/clipboard-client-linux
            bin/checksums.txt
            bin/*.tar.gz
            bin/*.zip

  build-macos:
    name: Build macOS clients
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev xorg-dev libxtst-dev libpng++-dev xcb libxcb-xkb-dev x11-xkb-utils libx11-xcb-dev libxkbcommon-x11-dev libxkbcommon-dev

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Get dependencies
        run: |
          rm -f go.sum
          go mod download
          go mod tidy

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Client (macOS ARM64)
        run: |
          GOARCH=arm64 go build \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -trimpath \
            -o bin/clipboard-client-macos-arm64 \
            ./cmd/client

      - name: Build Client (macOS x64)
        run: |
          GOARCH=amd64 go build \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" \
            -trimpath \
            -o bin/clipboard-client-macos-amd64 \
            ./cmd/client

      - name: Create macOS archives
        run: |
          cd bin
          tar -czf clipboard-client-macos-arm64-${{ steps.version.outputs.VERSION }}.tar.gz clipboard-client-macos-arm64
          tar -czf clipboard-client-macos-amd64-${{ steps.version.outputs.VERSION }}.tar.gz clipboard-client-macos-amd64

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-macos
          path: |
            bin/clipboard-client-macos-arm64
            bin/clipboard-client-macos-amd64
            bin/*.tar.gz

  release:
    name: Create Release
    needs: [build, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux
          path: bin/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries-macos
          path: bin/

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        run: |
          cat > release_notes.md << 'EOF'
          # OpenWRT Clipboard ${{ steps.version.outputs.VERSION }}
          
          Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð±ÑƒÑ„ÐµÑ€ Ð¾Ð±Ð¼ÐµÐ½Ð° Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ ÑÐµÑ‚Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ñ€Ð¾ÑƒÑ‚ÐµÑ€ OpenWRT.
          
          ## ðŸŽ¯ Ð§Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾
          
          - âœ… WebSocket ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð»Ñ OpenWRT (ARM64)
          - âœ… ÐšÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ Ð´Ð»Ñ Windows, Linux, macOS
          - âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±ÑƒÑ„ÐµÑ€Ð° Ð¾Ð±Ð¼ÐµÐ½Ð°
          - âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ€ÐµÐºÐ¾Ð½Ð½ÐµÐºÑ‚
          - âœ… Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
          
          ## ðŸ“¦ Ð¤Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ
          
          ### Ð¡ÐµÑ€Ð²ÐµÑ€ (OpenWRT)
          - `clipboard-server-openwrt-${{ steps.version.outputs.VERSION }}.tar.gz` - Ð´Ð»Ñ Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ð° Cudy WR3000S v1 Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ARM64 Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ð¾Ð²
          
          ### ÐšÐ»Ð¸ÐµÐ½Ñ‚Ñ‹
          - `clipboard-client-windows-${{ steps.version.outputs.VERSION }}.zip` - Ð´Ð»Ñ Windows 10/11 (x64)
          - `clipboard-client-linux-${{ steps.version.outputs.VERSION }}.tar.gz` - Ð´Ð»Ñ Linux (x64)
          - `clipboard-client-macos-arm64-${{ steps.version.outputs.VERSION }}.tar.gz` - Ð´Ð»Ñ macOS (Apple Silicon)
          - `clipboard-client-macos-amd64-${{ steps.version.outputs.VERSION }}.tar.gz` - Ð´Ð»Ñ macOS (Intel)
          
          ## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚
          
          ### 1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð½Ð° Ñ€Ð¾ÑƒÑ‚ÐµÑ€
          
          ```bash
          # Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¸ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ð°Ñ‚ÑŒ
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/clipboard-server-openwrt-${{ steps.version.outputs.VERSION }}.tar.gz
          tar -xzf clipboard-server-openwrt-${{ steps.version.outputs.VERSION }}.tar.gz
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð½Ð° Ñ€Ð¾ÑƒÑ‚ÐµÑ€
          scp clipboard-server-openwrt root@192.168.1.1:/tmp/clipboard-server
          
          # Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ðµ
          ssh root@192.168.1.1
          chmod +x /tmp/clipboard-server
          /tmp/clipboard-server -addr :8080
          ```
          
          ### 2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
          
          #### Windows
          ```cmd
          # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ð°Ñ‚ÑŒ ZIP
          # Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ: clipboard-client-windows.exe -server ws://192.168.1.1:8080/ws
          ```
          
          #### Linux
          ```bash
          tar -xzf clipboard-client-linux-${{ steps.version.outputs.VERSION }}.tar.gz
          sudo mv clipboard-client-linux /usr/local/bin/clipboard-client
          sudo chmod +x /usr/local/bin/clipboard-client
          clipboard-client -server ws://192.168.1.1:8080/ws
          ```
          
          #### macOS
          ```bash
          # Ð”Ð»Ñ Apple Silicon (M1/M2/M3)
          tar -xzf clipboard-client-macos-arm64-${{ steps.version.outputs.VERSION }}.tar.gz
          sudo mv clipboard-client-macos-arm64 /usr/local/bin/clipboard-client
          
          # Ð”Ð»Ñ Intel
          tar -xzf clipboard-client-macos-amd64-${{ steps.version.outputs.VERSION }}.tar.gz
          sudo mv clipboard-client-macos-amd64 /usr/local/bin/clipboard-client
          
          sudo chmod +x /usr/local/bin/clipboard-client
          clipboard-client -server ws://192.168.1.1:8080/ws
          ```
          
          ## ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
          
          ÐŸÐ¾Ð»Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸:
          - [QUICKSTART.md](https://github.com/${{ github.repository }}/blob/main/QUICKSTART.md) - ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸
          - [PROJECT_STATUS.md](https://github.com/${{ github.repository }}/blob/main/PROJECT_STATUS.md) - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          - [NOTES.md](https://github.com/${{ github.repository }}/blob/main/NOTES.md) - Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸
          
          ## ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸
          
          Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» `checksums.txt` Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ SHA256 Ñ…ÐµÑˆÐµÐ¹.
          
          ## âš ï¸ Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ
          
          - **Ð¡ÐµÑ€Ð²ÐµÑ€**: OpenWRT Ñ€Ð¾ÑƒÑ‚ÐµÑ€ Ñ ARM64 Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð¾Ð¹
          - **ÐšÐ»Ð¸ÐµÐ½Ñ‚Ñ‹**: Windows 10+, Linux, macOS 10.15+
          - **Ð¡ÐµÑ‚ÑŒ**: Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ ÑÐµÑ‚ÑŒ Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ Ðº Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ñƒ
          
          ## ðŸ› Ð¡Ð¾Ð¾Ð±Ñ‰Ð¸Ñ‚ÑŒ Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ðµ
          
          Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ð½Ð°ÑˆÐ»Ð¸ Ð±Ð°Ð³ Ð¸Ð»Ð¸ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ [Issue](https://github.com/${{ github.repository }}/issues).
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            bin/*.tar.gz
            bin/*.zip
            bin/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload individual binaries
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          files: |
            bin/clipboard-server-openwrt
            bin/clipboard-client-windows.exe
            bin/clipboard-client-linux
            bin/clipboard-client-macos-arm64
            bin/clipboard-client-macos-amd64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
